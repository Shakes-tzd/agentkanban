metadata:
  name: Alignment System
  created: 20251213-143000
  status: ready
overview: "Wire up existing drift detection code, add feature-level alignment fallback,\n\
  and surface warnings via additionalContext. Most infrastructure exists - \nthis\
  \ plan connects the pieces and adds missing fallbacks.\n"
research:
  approach: Hybrid Plan-Observation with keyword alignment (no embeddings)
  libraries:
  - name: None needed
    reason: All dependencies already in place
  patterns:
  - file: packages/claude-plugin/hooks/scripts/track-event.py:162
    description: Existing calculate_drift() function
  - file: packages/claude-plugin/hooks/scripts/track-event.py:460
    description: Existing handle_todowrite() function
  - file: packages/claude-plugin/hooks/scripts/graph_db_helper.py:1353
    description: Nudge tracking pattern (has_been_nudged/record_nudge)
  specifications:
  - requirement: Drift score 0.0-1.0 (1.0 = aligned)
    status: must_follow
  - requirement: Warning threshold >= 0.7 drift
    status: must_follow
  - requirement: No embeddings or external services
    status: must_follow
  dependencies:
    existing:
    - neo4j (Memgraph driver)
    - re (regex for keyword extraction)
    new: []
features:
- feature-level-alignment
- todowrite-step-verification
- drift-warning-injection
- session-work-accumulator
tasks:
- id: task-0
  name: Feature-Level Alignment Calculator
  file: tasks/task-0.md
  priority: high
  dependencies: []
- id: task-1
  name: "Verify TodoWrite \u2192 Steps Sync"
  file: tasks/task-1.md
  priority: high
  dependencies: []
- id: task-2
  name: Wire Drift Warnings to additionalContext
  file: tasks/task-2.md
  priority: blocker
  dependencies: []
- id: task-3
  name: Session Work Accumulator Alert
  file: tasks/task-3.md
  priority: medium
  dependencies:
  - task-2
shared_resources:
  files:
  - path: packages/claude-plugin/hooks/scripts/track-event.py
    reason: Tasks 0, 1, 2, 3 all modify this file
    mitigation: Sequential execution for tasks touching same functions
  - path: packages/claude-plugin/hooks/scripts/graph_db_helper.py
    reason: Tasks 0, 3 add new functions
    mitigation: Add functions at end of file, no conflicts
testing:
  unit:
  - Test calculate_feature_alignment() with various feature descriptions
  - Test Session Work event counting
  integration:
  - Verify drift warnings appear in Claude responses
  - Verify TodoWrite creates Steps
  isolation:
  - Each task can be tested independently
success_criteria:
- Drift score recorded on >80% of events
- Warnings surface when drift >= 0.7
- Session Work alert when > 20 events unattributed
- No regression in existing hook performance (<50ms added)
notes: 'Most code already exists! This plan focuses on:

  1. Wiring existing pieces together

  2. Adding feature-level fallback for when Steps don''t exist

  3. Surfacing warnings that are currently calculated but hidden

  '
changelog:
- timestamp: 20251213-143000
  event: Plan created from ctx:architect design
